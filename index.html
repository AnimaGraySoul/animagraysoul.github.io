<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Leaderboard</title>
    <style>
      * { box-sizing: border-box; }
      body {
        background: #121212;
        color: #e0e0e0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
        max-width: 980px;
        margin: 0 auto;
      }
      .tabs { display:flex; justify-content:center; gap:10px; margin-bottom:18px; }
      .tab-btn {
        padding:10px 12px; background:#252525; border:1px solid #333; border-radius:8px; color:inherit; cursor:pointer; display:flex; align-items:center; gap:8px;
      }
      .tab-btn.active{ background:#555; border-color:#777; }
      .tab-icon { width:22px; height:22px; filter: invert(0.85); display:block; }
      .tab-btn:focus { outline: none; box-shadow: 0 0 0 4px rgba(128,128,128,0.12); border-color: rgba(200,200,200,0.12); }
      .search-container { text-align:center; margin-bottom:18px; }
      .search-input {
        width:100%; max-width:520px; padding:12px; border-radius:8px; border:1px solid #333;
        background:#252525; color:inherit; font-size:15px;
      }
      .search-input:focus { outline: none; box-shadow: 0 0 0 4px rgba(128,128,128,0.12); border-color: rgba(200,200,200,0.06); }
      ::selection { background: #808080aa; color: #ccc; }
      .section { margin-bottom:18px; padding:8px 0; }
      .section-row { display:flex; gap:14px; align-items:flex-start; }
      :root { --thumb-h: clamp(180px, 24vw, 160px); --thumb-w: clamp(140px, 22vw, 180px); }
      .thumb-wrap { width: var(--thumb-w); height: var(--thumb-h); overflow:hidden; border-radius:12px; flex-shrink:0; display:flex; align-items:center; justify-content:center; background:#151515; border:1px solid rgba(255,255,255,0.03); }
      .object-thumb { display:block; width:100%; height:100%; object-fit:cover; object-position:center center; transform-origin:50% 40%; }
      .object-thumb.large { transform:scale(1.7); }
      .object-thumb.inline-thumb { transform:scale(1.3); }
      .object-header { display:flex; align-items:center; gap:10px; margin:0 0 8px 0; }
      .section-title { margin:0; font-size:1.05rem; color:#e6e6e6; line-height:1.1; }
      .top-three { flex:1; display:flex; flex-direction:column; gap:8px; justify-content:flex-start; min-height: var(--thumb-h); }
      .score-item { background:#252525; padding:12px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; }
      .score-item.compact { padding:10px; background:linear-gradient(90deg,#262626,#232323); }
      .user-name { font-weight:700; overflow:hidden; text-overflow:ellipsis; display:block; min-width:0; }
      .top-three .user-name { white-space:normal; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
      .time { min-width:72px; text-align:right; color:inherit; }
      .rest-results { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
      .user-results { background:#252525; border-radius:10px; margin-bottom:10px; overflow:hidden; }
      .user-header { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; cursor:pointer; color:#ccc; }
      .user-header:focus { outline:none; box-shadow:0 0 0 4px rgba(128,128,128,0.12); border-radius:8px; }
      .user-results-list { height:0; overflow:hidden; transition:height 240ms ease; will-change: height; }
      .user-results-list.scrollable { overflow:auto; -webkit-overflow-scrolling: touch; }
      .user-result-item { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:#2a2a2a; gap:12px; }
      .user-result-item:nth-child(even) { background:#252525; }
      .inline-thumb-wrap { width:64px; height:64px; overflow:hidden; border-radius:8px; flex-shrink:0; display:flex; align-items:center; justify-content:center; background:#141414; border:1px solid rgba(255,255,255,0.03); }
      .rank { font-weight:700; margin-right:8px; min-width:28px; }
      .user-info { display:flex; align-items:center; gap:12px; flex:1; min-width:0; }
      .top-1-name { background:linear-gradient(90deg,#fff,#ccc); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; font-weight:800; }
      @media (max-width:720px) {
        :root { --thumb-h: 120px; --thumb-w: 120px; }
        .inline-thumb-wrap { width:56px; height:56px; }
      }
      @media (max-width:520px) {
        .section-row { flex-direction:column; align-items:center; }
        :root { --thumb-h: 120px; --thumb-w: 120px; }
        .top-three { width:100%; min-height: var(--thumb-h); }
        .score-item.compact .user-name { white-space:normal; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
      }
    </style>
  </head>
  <body>
    <div class="tabs">
      <button class="tab-btn active" data-tab="leaderboard"><img src="https://animagraysoul.github.io/leaderboard.svg" alt="Leaderboard" class="tab-icon" /></button>
      <button class="tab-btn" data-tab="users"><img src="https://animagraysoul.github.io/users.svg" alt="Users" class="tab-icon" /></button>
    </div>

    <div class="search-container">
      <input id="searchInput" class="search-input" type="text" />
    </div>

    <div id="content"></div>

    <script>
      const usersUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTlduY1vt3BXg9eFp770mae8bjMi36YVPnbSaVkfU_4a53qghaVLuYBoq6rhS6gJ_Qx357uZqdeGKJK/pub?gid=0&single=true&output=csv";
      const objectsUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTlduY1vt3BXg9eFp770mae8bjMi36YVPnbSaVkfU_4a53qghaVLuYBoq6rhS6gJ_Qx357uZqdeGKJK/pub?gid=775717868&single=true&output=csv";
      const leaderboardUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTlduY1vt3BXg9eFp770mae8bjMi36YVPnbSaVkfU_4a53qghaVLuYBoq6rhS6gJ_Qx357uZqdeGKJK/pub?gid=863611613&single=true&output=csv";

      let users = [], objects = [];
      let leaderboardResults = {}, userResults = {}, wrCounts = {};
      let currentTab = "leaderboard", top1Player = "";

      const PLACEHOLDER_SVG = `<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='100%' height='100%' fill='#101010'/><g fill='#6f6f6f' font-family='Arial,Helvetica,sans-serif' font-size='36' text-anchor='middle'><text x='50%' y='48%'>No</text><text x='50%' y='60%'>image</text></g></svg>`;
      const PLACEHOLDER = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(PLACEHOLDER_SVG);

      function escapeHtml(s) {
        if (typeof s !== "string") return "";
        return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
      }

      function normalizeForSearch(s) {
        if (typeof s !== "string") return "";
        return s.normalize("NFKD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
      }

      async function fetchData(url, isObjects = false) {
        try {
          const res = await fetch(url);
          const txt = await res.text();
          const lines = txt.split("\n");
          const out = [];
          for (let i = 1; i < lines.length; i++) {
            const cells = lines[i].split(",");
            if (cells[0] && cells[0].trim() !== "") {
              if (isObjects) out.push({ id: i, name: cells[0].trim(), nameNorm: normalizeForSearch(cells[0].trim()) });
              else out.push(cells[0].trim());
            }
          }
          return out;
        } catch (e) { console.error(e); return []; }
      }

      async function fetchResults() {
        try {
          const res = await fetch(leaderboardUrl);
          const txt = await res.text();
          const lines = txt.split("\n");
          const allowed = new Set();
          for (let i = 1; i < lines.length; i++) {
            const cells = lines[i].split(",");
            if (cells[3] && cells[3].trim() !== "") {
              const p = parseInt(cells[3].trim(), 10);
              if (!Number.isNaN(p)) allowed.add(p);
            }
          }
          const results = [];
          for (let i = 1; i < lines.length; i++) {
            const cells = lines[i].split(",");
            const rowId = i;
            if (!allowed.has(rowId)) continue;
            if (!(cells[0] && cells[1] && cells[2])) continue;
            const objectIdRaw = parseInt(cells[0].trim(), 10);
            const userIdRaw = parseInt(cells[1].trim(), 10);
            const timeRaw = parseFloat(cells[2].trim());
            if (Number.isNaN(objectIdRaw) || Number.isNaN(userIdRaw) || Number.isNaN(timeRaw)) continue;
            const objectId = objectIdRaw - 1;
            const userId = userIdRaw - 1;
            const time = timeRaw;
            if (objects[objectId] && users[userId]) {
              results.push({ objectId, objectName: objects[objectId].name, user: users[userId], time });
            }
          }
          return results;
        } catch (e) { console.error(e); return []; }
      }

      function groupByObject(results) {
        const groups = {};
        results.forEach(r => {
          const k = r.objectId;
          if (!groups[k]) groups[k] = { name: r.objectName, results: [] };
          groups[k].results.push(r);
        });
        Object.keys(groups).forEach(k => groups[k].results.sort((a,b) => a.time - b.time));
        return groups;
      }

      function groupByUser(results) {
        const groups = {};
        results.forEach(r => {
          const k = r.user;
          if (!groups[k]) groups[k] = { results: [] };
          groups[k].results.push({ objectName: r.objectName, time: r.time });
        });
        return groups;
      }

      function calculateWRCounts(groups) {
        const out = {};
        Object.keys(groups).forEach(objectId => {
          const arr = groups[objectId].results;
          if (arr.length > 0) {
            const best = arr[0].time;
            const holders = arr.filter(x => Math.abs(x.time - best) < 1e-9);
            holders.forEach(h => { if (!out[h.user]) out[h.user] = 0; out[h.user]++; });
          }
        });
        return out;
      }

      function getTop1Player(counts) {
        let top = "", max = 0;
        Object.entries(counts).forEach(([u,c]) => { if (c > max) { max = c; top = u; } });
        return top;
      }

      function findObjectByName(name) {
        for (let i=0;i<objects.length;i++) if ((objects[i].name||"").toLowerCase() === (name||"").toLowerCase()) return objects[i];
        return null;
      }

      function displayLeaderboard(groups) {
        const rawSearch = document.getElementById("searchInput").value || "";
        const search = normalizeForSearch(rawSearch);
        const sortedObjects = objects.slice().sort((a,b) => a.name.localeCompare(b.name, "pl", {sensitivity:"base"}));
        let html = "";
        let found = false;
        sortedObjects.forEach(obj => {
          if (search && !obj.nameNorm.includes(search)) return;
          const key = obj.id - 1;
          if (!groups[key]) return;
          found = true;
          const arr = groups[key].results;
          const firstThree = arr.slice(0,3);
          const rest = arr.slice(3);
          const imgUrl = `https://animagraysoul.github.io/object/${obj.id}.apng`;
          html += `<div class="section">`;
          html += `<div class="section-row">`;
          html += `<div class="thumb-wrap"><img loading="lazy" decoding="async" class="object-thumb large lazy-img" alt="${escapeHtml(obj.name)}" data-src="${imgUrl}" src="${PLACEHOLDER}"></div>`;
          html += `<div class="top-three">`;
          html += `<div class="object-header"><h3 class="section-title">${escapeHtml(obj.name)}</h3></div>`;
          firstThree.forEach((r, idx) => {
            const userClass = (r.user === top1Player) ? "top-1-name" : "";
            html += `<div class="score-item compact"><div style="display:flex;align-items:center;gap:8px;min-width:0"><span class="user-name ${userClass}">${idx+1}. ${escapeHtml(r.user)}</span></div><span class="time">${r.time.toFixed(2)}s</span></div>`;
          });
          html += `</div>`;
          html += `</div>`;
          if (rest.length > 0) {
            html += `<div class="rest-results">`;
            rest.forEach((r, idx) => {
              const rankNum = idx + 4;
              const userClass = (r.user === top1Player) ? "top-1-name" : "";
              html += `<div class="score-item"><span class="user-name ${userClass}">${rankNum}. ${escapeHtml(r.user)}</span><span class="time">${r.time.toFixed(2)}s</span></div>`;
            });
            html += `</div>`;
          }
          html += `</div>`;
        });
        if (!found) html = `<div class="no-results">No objects found</div>`;
        document.getElementById("content").innerHTML = html;
        observeLazyImages();
      }

      function displayUsers() {
        const rawSearch = document.getElementById("searchInput").value || "";
        const searchTerm = rawSearch.trim();
        const filter = parseSearchQuery(searchTerm);
        let sortedUsers = Object.entries(wrCounts).map(([user,count]) => ({user,count})).sort((a,b)=>b.count-a.count);
        const usersWithRanks = [];
        let curRank = 1;
        let prevCount = sortedUsers[0]?.count || 0;
        for (let i=0;i<sortedUsers.length;i++){
          if (i>0 && sortedUsers[i].count < prevCount){ curRank++; prevCount = sortedUsers[i].count; }
          usersWithRanks.push({ user: sortedUsers[i].user, count: sortedUsers[i].count, rank: curRank });
        }
        const top5 = new Set(usersWithRanks.filter(p=>p.rank<=5).map(p=>p.user));
        let displayed = usersWithRanks;
        if (searchTerm) displayed = usersWithRanks.filter(p => filter(p.count, p.user));
        let html = "";
        if (displayed.length === 0) html = `<div class="no-results">No users found</div>`;
        else {
          displayed.forEach((p,i) => {
            const userName = p.user;
            if (!userResults[userName]) return;
            const isTop1 = p.rank === 1;
            const topClass = isTop1 ? "top-1-player" : (top5.has(userName) ? "top-player" : "");
            html += `<div class="user-results ${topClass}">`;
            html += `<div class="user-header" role="button" tabindex="0" aria-expanded="false"><div style="display:flex;align-items:center;gap:12px;"><span class="rank">${p.rank}.</span><span class="${isTop1 ? "top-1-name":""}" style="font-weight:600">${escapeHtml(userName)}</span></div><div style="margin-left:auto"><span class="user-wr-count">${p.count} WR</span></div></div>`;
            html += `<div class="user-results-list" aria-hidden="true">`;
            const sortedResults = (userResults[userName].results || []).slice().sort((a,b) => (a.objectName||"").localeCompare(b.objectName||"", "pl", {sensitivity:"base"}));
            sortedResults.forEach((r, idx) => {
              const obj = findObjectByName(r.objectName);
              const imgUrl = obj ? `https://animagraysoul.github.io/object/${obj.id}.apng` : "";
              html += `<div class="user-result-item"><div style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;"><div class="inline-thumb-wrap"><img class="object-thumb inline-thumb lazy-img" alt="${escapeHtml(r.objectName)}" data-src="${imgUrl}" src="${PLACEHOLDER}"></div><div style="min-width:0"><div style="font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(r.objectName)}</div></div></div><div style="min-width:72px;text-align:right">${r.time.toFixed(2)}s</div></div>`;
            });
            html += `</div></div>`;
          });
        }
        document.getElementById("content").innerHTML = html;
        document.querySelectorAll(".user-results-list").forEach(l => { l.style.height = "0px"; l.style.maxHeight = ""; l.classList.remove("scrollable"); l.style.overflow = ""; });
        document.querySelectorAll(".user-header").forEach(h => {
          h.addEventListener("click", () => toggleUserResults(h));
          h.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleUserResults(h); } });
        });
        observeLazyImages();
      }

      function parseSearchQuery(query) {
        const raw = query.trim();
        if (/^\d+$/.test(raw)) { const num = parseInt(raw); return (count,user)=>count===num; }
        if (/^>\s*(\d+)$/.test(raw)) { const num = parseInt(raw.match(/^>\s*(\d+)$/)[1]); return (count,user)=>count>num; }
        if (/^>=\s*(\d+)$/.test(raw)) { const num = parseInt(raw.match(/^>=\s*(\d+)$/)[1]); return (count,user)=>count>=num; }
        if (/^<\s*(\d+)$/.test(raw)) { const num = parseInt(raw.match(/^<\s*(\d+)$/)[1]); return (count,user)=>count<num; }
        if (/^<=\s*(\d+)$/.test(raw)) { const num = parseInt(raw.match(/^<=\s*(\d+)$/)[1]); return (count,user)=>count<=num; }
        const norm = normalizeForSearch(raw);
        return (count,user) => normalizeForSearch(user).includes(norm);
      }

      function toggleUserResults(header) {
        const list = header.nextElementSibling;
        const expanded = header.getAttribute("aria-expanded") === "true";
        const MAX_VISIBLE = 360;
        if (expanded) {
          const curH = list.getBoundingClientRect().height;
          list.style.height = curH + "px";
          list.offsetHeight;
          list.style.transition = `height 220ms ease`;
          requestAnimationFrame(()=> list.style.height = "0px");
          const onEnd = () => { list.classList.remove("scrollable"); list.style.maxHeight = ""; list.style.overflow = ""; list.setAttribute("aria-hidden","true"); header.setAttribute("aria-expanded","false"); list.removeEventListener("transitionend", onEnd); list.style.transition = ""; };
          list.addEventListener("transitionend", onEnd);
        } else {
          list.style.height = "auto";
          const full = list.scrollHeight;
          const duration = Math.max(180, Math.min(600, Math.round(full / 1.2)));
          if (full > MAX_VISIBLE) {
            list.classList.add("scrollable");
            list.style.overflow = "auto";
            list.style.maxHeight = MAX_VISIBLE + "px";
            list.setAttribute("aria-hidden","false");
            header.setAttribute("aria-expanded","true");
            list.style.height = "0px";
            list.offsetHeight;
            list.style.transition = `height ${duration}ms ease`;
            requestAnimationFrame(()=> list.style.height = MAX_VISIBLE + "px");
            const onEnd = () => { list.style.height = MAX_VISIBLE + "px"; list.removeEventListener("transitionend", onEnd); list.style.transition = ""; };
            list.addEventListener("transitionend", onEnd);
          } else {
            list.classList.remove("scrollable");
            list.style.overflow = "";
            list.style.maxHeight = "";
            list.setAttribute("aria-hidden","false");
            header.setAttribute("aria-expanded","true");
            list.style.height = "0px";
            list.offsetHeight;
            list.style.transition = `height ${duration}ms ease`;
            requestAnimationFrame(()=> list.style.height = full + "px");
            const onEnd = () => { list.style.height = "auto"; list.removeEventListener("transitionend", onEnd); list.style.transition = ""; };
            list.addEventListener("transitionend", onEnd);
          }
        }
      }

      let lazyObserver = null;
      function observeLazyImages() {
        const imgs = Array.from(document.querySelectorAll("img.lazy-img"));
        if (!("IntersectionObserver" in window)) { imgs.forEach(loadImgImmediately); return; }
        if (!lazyObserver) {
          lazyObserver = new IntersectionObserver((entries) => {
            entries.forEach(en => {
              if (en.isIntersecting) { loadImg(en.target); lazyObserver.unobserve(en.target); }
            });
          }, { rootMargin: "300px 0px" });
        }
        imgs.forEach(img => { if (img.datasetLoaded) return; lazyObserver.observe(img); });
      }
      function loadImgImmediately(img) { const s = img.getAttribute("data-src"); if (s) img.src = s; img.onerror = () => img.src = PLACEHOLDER; img.datasetLoaded = true; }
      function loadImg(img) { const s = img.getAttribute("data-src"); if (!s) { img.src = PLACEHOLDER; img.datasetLoaded = true; return; } img.src = s; img.onerror = () => img.src = PLACEHOLDER; img.datasetLoaded = true; }

      function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
        displayContent();
      }

      function displayContent() {
        if (currentTab === "users") displayUsers();
        else displayLeaderboard(leaderboardResults);
      }

      document.addEventListener("DOMContentLoaded", async () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.addEventListener("click", () => switchTab(b.dataset.tab)));
        document.getElementById("searchInput").addEventListener("input", () => displayContent());
        users = await fetchData(usersUrl);
        objects = await fetchData(objectsUrl, true);
        const results = await fetchResults();
        leaderboardResults = groupByObject(results);
        userResults = groupByUser(results);
        wrCounts = calculateWRCounts(leaderboardResults);
        top1Player = getTop1Player(wrCounts);
        displayContent();
        window.addEventListener("resize", () => {
          document.querySelectorAll(".user-results-list").forEach(list => {
            const header = list.previousElementSibling;
            const expanded = header && header.getAttribute("aria-expanded") === "true";
            if (!expanded) return;
            if (list.classList.contains("scrollable")) return;
            list.style.transition = "";
            list.style.height = list.scrollHeight + "px";
          });
        });
      });
    </script>
  </body>
</html>
